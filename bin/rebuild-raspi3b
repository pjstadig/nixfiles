#!/usr/bin/env zsh
set -euo pipefail

flakedir="$(readlink -f $(dirname $0)/..)"

nix flake lock --refresh --update-inputs home-manager --update-inputs nixpkgs "${flakedir}"

nixos-rebuild switch \
              --flake "${flakedir}#raspi3b" \
              --target-host root@raspi3b.lan \
              --fast \
              --refresh \
              --override-input secrets "${flakedir}/../nixfiles-secrets" \
              --override-input thoughtfull "${flakedir}/../thoughtfull/nixfiles" \
              "${@}"

nix flake lock --refresh --update-input secrets --update-input thoughtfull "${flakedir}"
